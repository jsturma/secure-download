load_module modules/ngx_http_js_module.so;

js_import redis_session from /etc/nginx/redis_session.js;

server {
    listen 443 ssl;
    server_name _;

    ssl_certificate     /etc/nginx/ssl/local.crt;
    ssl_certificate_key /etc/nginx/ssl/local.key;

    # --- JWT Validation with Vault JWKS ---
    auth_jwt "Restricted";
    auth_jwt_key_request /jwks;
    auth_jwt_alg RS256;
    auth_jwt_cache_time 30m;

    # JWKS endpoint proxy
    location = /jwks {
        proxy_pass https://vault.example.com/v1/identity/oidc/.well-known/keys;
    }

    # --- Session Management (Redis) ---
    location /session_check {
        internal;
        js_content redis_session.jwt_to_session;
    }

    # --- Main protected download area ---
    location /download/ {
        alias /data/downloads/;

        # Step 1 : Check JWT or Session
        error_page 401 = @start_session;

        # Only GET or HEAD
        limit_except GET HEAD { deny all; }

        autoindex on;
    }

    # When JWT ok â†’ create session
    location @start_session {
        js_content redis_session.jwt_to_session;
    }
}
