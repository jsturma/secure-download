# Redis auth helper
lua_shared_dict sessions 10m;

lua_package_path "/usr/local/openresty/lualib/?.lua;;";

resolver 8.8.8.8;

init_by_lua_block {
  redis = require "resty.redis"
}

server {
    listen 443 ssl;
    server_name _;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # --------------------------
    # 1) Vérification initiale JWT via Vault JWKS
    # --------------------------
    lua_shared_dict jwks_cache 1m;

    location = /auth {
        internal;
        content_by_lua_block {
            local jwt = ngx.var.arg_token
            if not jwt then
                ngx.exit(401)
            end

            -- Redis connection
            local r = redis:new()
            r:set_timeout(100)
            assert(r:connect("redis", 6379))

            -- si déjà validé → OK instantané
            local exists = r:get("sess:"..jwt)
            if exists == "1" then
                ngx.say("OK")
                return
            end

            -- Valider JWT via Vault JWKS
            local http = require "resty.http"
            local h = http.new()
            local resp, err = h:request_uri("http://vault:8200/v1/identity/oidc/.well-known/keys")
            if not resp then
                ngx.exit(500)
            end

            local jwks = require "resty.jwk"
            local jwt_parser = require "resty.jwt"

            local validators = {
                exp = true,
                iss = "https://vault.local",
                sub = ngx.var.remote_user or "default",
                aud = "nginx"
            }

            local jwt_obj = jwt_parser:verify_jwks(resp.body, jwt, validators)
            if not jwt_obj.valid then
                ngx.exit(401)
            end

            -- Stocker en Redis → TTL 30 minutes
            r:setex("sess:"..jwt, 1800, "1")

            ngx.say("OK")
        }
    }

    # --------------------------
    # 2) Zone protégée
    # --------------------------
    location /files/ {

        # appeler l’auth interne une seule fois
        access_by_lua_block {
            local args = ngx.req.get_uri_args()
            local jwt = args.token
            if not jwt then
                ngx.exit(401)
            end

            local res = ngx.location.capture("/auth?token="..jwt)
            if res.status ~= 200 then
                ngx.exit(401)
            end
        }

        alias /data/;

        # lecture seule
        limit_except GET HEAD {
            deny all;
        }

        autoindex on;
    }
}
